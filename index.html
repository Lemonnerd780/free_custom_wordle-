<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Wordle Creator Pro</title>
    <style>
        :root { --color-correct: #6aaa64; --color-present: #c9b458; --color-absent: #3a3a3c; --bg: #121213; }
        body { font-family: sans-serif; background: var(--bg); color: white; text-align: center; margin: 0; padding: 10px; }
        .setup-box { background: #1e1e1f; padding: 20px; border-radius: 10px; display: inline-block; margin-top: 20px; width: 90%; max-width: 400px; border: 1px solid #333; }
        input, textarea { padding: 15px; font-size: 1rem; background: #000; border: 1px solid #444; color: white; border-radius: 5px; width: 100%; box-sizing: border-box; }
        button { padding: 15px; background: var(--color-correct); color: white; border: none; font-weight: bold; border-radius: 5px; cursor: pointer; margin: 10px 0; width: 100%; -webkit-appearance: none; }
        #grid { display: grid; gap: 5px; justify-content: center; margin-top: 10px; }
        .tile { width: 45px; height: 45px; perspective: 1000px; }
        .tile-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flipped .tile-inner { transform: rotateX(180deg); }
        .tile-front, .tile-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; text-transform: uppercase; border: 2px solid #3a3a3c; box-sizing: border-box; }
        .tile-back { transform: rotateX(180deg); border: none; }
        .correct .tile-back { background: var(--color-correct); }
        .present .tile-back { background: var(--color-present); }
        .absent .tile-back { background: var(--color-absent); }
        #message { height: 30px; margin: 10px; font-weight: bold; color: #f1c40f; }
    </style>
</head>
<body>

    <div id="setup">
        <div class="setup-box">
            <h2>Wordle Builder</h2>
            <input type="text" id="wInput" placeholder="SECRET WORD" maxlength="12">
            <button onclick="makeLink()">Generate Challenge Link</button>
            <div id="out"></div>
        </div>
    </div>

    <div id="game" style="display:none;">
        <div id="grid"></div>
        <div id="message"></div>
        <button id="share" style="display:none; background:#2f7ed8" onclick="doShare()">SHARE RESULTS</button>
        <button onclick="window.location.href=window.location.pathname" style="background:#444">CREATE NEW</button>
    </div>

<script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    let target = "", curRow = 0, curGuess = "", gameOver = false, emojis = [], maxAllowed = 6;

    // 1. STARTUP
    if (code) {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        try {
            target = decodeURIComponent(escape(atob(code))).toUpperCase();
            maxAllowed = target.length + 1;
            initGrid();
        } catch(e) { alert("Error loading link. Starting fresh."); window.location.href = window.location.pathname; }
    }

    // 2. LINK GENERATION (MOBILE FRIENDLY)
    function makeLink() {
        try {
            const val = document.getElementById('wInput').value.trim();
            if (val.length < 3) { alert("Word too short!"); return; }
            
            // Safe encoding for mobile
            const encrypted = btoa(unescape(encodeURIComponent(val)));
            const link = window.location.origin + window.location.pathname + "?code=" + encrypted;
            
            document.getElementById('out').innerHTML = `
                <p>Challenge Ready! Copy link:</p>
                <textarea id="linkBox" readonly style="height:80px; font-size:0.8rem;">${link}</textarea>
                <button onclick="copyToClipboard()" id="cBtn" style="background:#555">Copy Link</button>
            `;
        } catch(err) {
            alert("Generation failed: " + err.message);
        }
    }

    async function copyToClipboard() {
        const box = document.getElementById('linkBox');
        const btn = document.getElementById('cBtn');
        try {
            await navigator.clipboard.writeText(box.value);
            btn.innerText = "COPIED!";
            btn.style.background = "#6aaa64";
        } catch(e) {
            box.select();
            document.execCommand('copy');
            btn.innerText = "COPIED!";
        }
    }

    // 3. GAME LOGIC
    function initGrid() {
        const g = document.getElementById('grid');
        g.style.gridTemplateColumns = `repeat(${target.length}, 45px)`;
        for (let i = 0; i < maxAllowed * target.length; i++) {
            const t = document.createElement('div');
            t.className = 'tile'; t.id = 't-' + i;
            t.innerHTML = `<div class="tile-inner"><div class="tile-front"></div><div class="tile-back"></div></div>`;
            g.appendChild(t);
        }

        // Invisible input for Mobile Keyboard
        const input = document.createElement('input');
        input.type = 'text'; input.style.position = 'fixed'; input.style.top = '-100px';
        input.autocapitalize = 'none'; input.autocomplete = 'off';
        document.body.appendChild(input);

        document.body.onclick = () => { if(!gameOver) input.focus(); };
        
        input.oninput = (e) => {
            const char = e.target.value.slice(-1);
            if (/^[a-zA-Z]$/.test(char)) addLetter(char.toUpperCase());
            e.target.value = "";
        };

        window.onkeydown = (e) => {
            if (gameOver) return;
            if (e.key === 'Enter') submitGuess();
            if (e.key === 'Backspace') delLetter();
            if (/^[a-zA-Z]$/.test(e.key)) addLetter(e.key.toUpperCase());
        };
    }

    function addLetter(l) {
        if (curGuess.length < target.length) {
            document.querySelector(`#t-${curRow * target.length + curGuess.length} .tile-front`).innerText = l;
            curGuess += l;
        }
    }

    function delLetter() {
        if (curGuess.length > 0) {
            curGuess = curGuess.slice(0, -1);
            document.querySelector(`#t-${curRow * target.length + curGuess.length} .tile-front`).innerText = "";
        }
    }

    async function submitGuess() {
        if (curGuess.length !== target.length) return;
        
        // Dictionary Check
        if (curGuess !== target) {
            try {
                const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${curGuess}`);
                if (!r.ok) { document.getElementById('message').innerText = "NOT IN WORD LIST"; return; }
            } catch(e) {}
        }

        document.getElementById('message').innerText = "";
        const states = Array(target.length).fill('absent');
        const counts = {};
        target.split('').forEach(l => counts[l] = (counts[l] || 0) + 1);

        curGuess.split('').forEach((l, i) => { if (l === target[i]) { states[i] = 'correct'; counts[l]--; } });
        curGuess.split('').forEach((l, i) => { if (states[i] !== 'correct' && counts[l] > 0) { states[i] = 'present'; counts[l]--; } });

        let rowEmo = "";
        for (let i = 0; i < target.length; i++) {
            const t = document.getElementById('t-' + (curRow * target.length + i));
            t.querySelector('.tile-back').innerText = curGuess[i];
            setTimeout(() => {
                t.classList.add(states[i]); t.classList.add('flipped');
                rowEmo += states[i] === 'correct' ? "ðŸŸ©" : (states[i] === 'present' ? "ðŸŸ¨" : "â¬›");
                if (i === target.length - 1) {
                    emojis.push(rowEmo);
                    if (curGuess === target) { document.getElementById('message').innerText = "GENIUS!"; endGame(); }
                    else if (curRow === maxAllowed - 1) { document.getElementById('message').innerText = target; endGame(); }
                    else { curRow++; curGuess = ""; }
                }
            }, i * 150);
        }
    }

    function endGame() { gameOver = true; document.getElementById('share').style.display = 'block'; }
    function doShare() {
        const text = `Wordle Remix ${curRow + 1}/${maxAllowed}\n\n${emojis.join('\n')}`;
        navigator.clipboard.writeText(text); alert("Copied results!");
    }
</script>
</body>
</html>
