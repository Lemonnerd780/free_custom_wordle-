<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Wordle Remix æœ€ç»ˆä¿®å¤ç‰ˆ</title>
    <style>
        :root { --color-correct: #6aaa64; --color-present: #c9b458; --color-absent: #3a3a3c; --bg: #121213; }
        body { font-family: sans-serif; background: var(--bg); color: white; text-align: center; margin: 0; padding: 10px; overflow: hidden; touch-action: manipulation; }
        
        .setup-box { background: #1e1e1f; padding: 20px; border-radius: 10px; display: inline-block; margin-top: 20px; width: 90%; max-width: 400px; border: 1px solid #333; }
        input, textarea { padding: 15px; font-size: 1rem; background: #000; border: 1px solid #444; color: white; border-radius: 5px; width: 100%; box-sizing: border-box; }
        button { padding: 15px; background: var(--color-correct); color: white; border: none; font-weight: bold; border-radius: 5px; cursor: pointer; margin: 10px 0; width: 100%; }
        
        #grid { display: grid; gap: 5px; justify-content: center; margin-top: 10px; }
        .tile { width: 45px; height: 45px; perspective: 1000px; }
        .tile-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flipped .tile-inner { transform: rotateX(180deg); }
        .tile-front, .tile-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; text-transform: uppercase; border: 2px solid #3a3a3c; box-sizing: border-box; }
        .tile-back { transform: rotateX(180deg); border: none; color: white; }

        .correct .tile-back { background: var(--color-correct); }
        .present .tile-back { background: var(--color-present); }
        .absent .tile-back { background: var(--color-absent); }
        
        #message { height: 30px; margin: 10px; font-weight: bold; color: #f1c40f; }
        
        /* ç§»åŠ¨ç«¯ä¸“ç”¨è¾…åŠ©æŒ‰é’® */
        .mobile-controls { display: none; margin-top: 15px; gap: 10px; justify-content: center; }
        @media (max-width: 600px) { .mobile-controls { display: flex; } }
        .m-btn { width: 80px; padding: 10px; background: #555; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="setup">
        <div class="setup-box">
            <h2>Wordle ç”Ÿæˆå™¨</h2>
            <input type="text" id="wInput" placeholder="è¾“å…¥å¯†é’¥å•è¯" maxlength="12">
            <button onclick="makeLink()">ç”ŸæˆæŒ‘æˆ˜é“¾æ¥</button>
            <div id="out"></div>
        </div>
    </div>

    <div id="game" style="display:none;">
        <div id="grid"></div>
        <div id="message"></div>
        <div class="mobile-controls">
            <button class="m-btn" onclick="submitGuess()">ç¡®è®¤ (ENTER)</button>
            <button class="m-btn" onclick="delLetter()">é€€æ ¼ (DEL)</button>
        </div>
        <button id="shareBtn" style="display:none; background:#2f7ed8" onclick="doShare()">åˆ†äº«æˆ˜ç»© ğŸŸ©</button>
        <button onclick="window.location.href=window.location.pathname" style="background:#444; width:auto; padding:10px 20px;">åˆ›å»ºæ–°å•è¯</button>
    </div>

<script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    let target = "", curRow = 0, curGuess = "", gameOver = false, emojis = [], maxAllowed = 6;

    if (code) {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        try {
            target = decodeURIComponent(escape(atob(code))).toUpperCase();
            maxAllowed = target.length + 1;
            initGrid();
        } catch(e) { window.location.href = window.location.pathname; }
    }

    function makeLink() {
        const val = document.getElementById('wInput').value.trim();
        if (val.length < 3) { alert("å•è¯å¤ªçŸ­äº†ï¼"); return; }
        const encrypted = btoa(unescape(encodeURIComponent(val)));
        const link = window.location.origin + window.location.pathname + "?code=" + encrypted;
        document.getElementById('out').innerHTML = `<textarea id="linkBox" readonly style="margin-top:10px; height:60px;">${link}</textarea><button onclick="copyToClipboard()" id="cBtn" style="background:#555">å¤åˆ¶é“¾æ¥</button>`;
    }

    async function copyToClipboard() {
        const box = document.getElementById('linkBox');
        try { await navigator.clipboard.writeText(box.value); alert("å¤åˆ¶æˆåŠŸï¼"); } 
        catch(e) { box.select(); document.execCommand('copy'); alert("å¤åˆ¶æˆåŠŸï¼"); }
    }

    function initGrid() {
        const g = document.getElementById('grid');
        g.style.gridTemplateColumns = `repeat(${target.length}, 45px)`;
        for (let i = 0; i < maxAllowed * target.length; i++) {
            const t = document.createElement('div');
            t.className = 'tile'; t.id = 't-' + i;
            t.innerHTML = `<div class="tile-inner"><div class="tile-front"></div><div class="tile-back"></div></div>`;
            g.appendChild(t);
        }

        const mInput = document.createElement('input');
        mInput.type = 'text'; mInput.style.position = 'fixed'; mInput.style.top = '-100px';
        mInput.autocapitalize = 'none'; mInput.autocomplete = 'off';
        document.body.appendChild(mInput);

        // ç‚¹å‡»å±å¹•å”¤èµ·é”®ç›˜
        document.body.onclick = (e) => { 
            if(!gameOver && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') mInput.focus(); 
        };
        
        // æ‰‹æœºè¾“å…¥é€»è¾‘ï¼šåªå¤„ç†å­—æ¯ï¼Œä¸é‡å¤
        mInput.oninput = (e) => {
            const char = e.target.value.slice(-1);
            if (/^[a-zA-Z]$/.test(char)) addLetter(char.toUpperCase());
            e.target.value = ""; 
        };

        // é”®ç›˜é€»è¾‘ï¼šå¤„ç† Laptop å­—æ¯ + å…¨å¹³å°ç‰¹æ®Šé”®
        window.onkeydown = (e) => {
            if (gameOver) return;
            if (e.key === 'Enter') { e.preventDefault(); submitGuess(); }
            else if (e.key === 'Backspace') { e.preventDefault(); delLetter(); }
            else if (/^[a-zA-Z]$/.test(e.key)) {
                // å¦‚æœå½“å‰ç„¦ç‚¹ä¸åœ¨éšè—è¾“å…¥æ¡†ï¼Œè¯´æ˜æ˜¯ç¬”è®°æœ¬ç‰©ç†é”®ç›˜ï¼Œæ‰å¤„ç†
                if (document.activeElement !== mInput) {
                    addLetter(e.key.toUpperCase());
                }
            }
        };
    }

    function addLetter(l) {
        if (curGuess.length < target.length) {
            document.querySelector(`#t-${curRow * target.length + curGuess.length} .tile-front`).innerText = l;
            curGuess += l;
        }
    }

    function delLetter() {
        if (curGuess.length > 0) {
            curGuess = curGuess.slice(0, -1);
            document.querySelector(`#t-${curRow * target.length + curGuess.length} .tile-front`).innerText = "";
        }
    }

    async function submitGuess() {
        if (curGuess.length !== target.length) return;
        
        // å­—å…¸æ£€æŸ¥
        if (curGuess !== target) {
            const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${curGuess}`).catch(()=>{});
            if (r && !r.ok) { document.getElementById('message').innerText = "å•è¯ä¸åœ¨åˆ—è¡¨å†…"; return; }
        }

        document.getElementById('message').innerText = "";
        const states = Array(target.length).fill('absent');
        const counts = {};
        target.split('').forEach(l => counts[l] = (counts[l] || 0) + 1);

        curGuess.split('').forEach((l, i) => { if (l === target[i]) { states[i] = 'correct'; counts[l]--; } });
        curGuess.split('').forEach((l, i) => { if (states[i] !== 'correct' && counts[l] > 0) { states[i] = 'present'; counts[l]--; } });

        let rowEmo = "";
        for (let i = 0; i < target.length; i++) {
            const t = document.getElementById('t-' + (curRow * target.length + i));
            t.querySelector('.tile-back').innerText = curGuess[i];
            setTimeout(() => {
                t.classList.add(states[i]); t.classList.add('flipped');
                rowEmo += states[i] === 'correct' ? "ğŸŸ©" : (states[i] === 'present' ? "ğŸŸ¨" : "â¬›");
                if (i === target.length - 1) {
                    emojis.push(rowEmo);
                    if (curGuess === target) { document.getElementById('message').innerText = "å¤ªæ£’äº†ï¼"; finish(); }
                    else if (curRow === maxAllowed - 1) { document.getElementById('message').innerText = "ç­”æ¡ˆæ˜¯: " + target; finish(); }
                    else { curRow++; curGuess = ""; }
                }
            }, i * 150);
        }
    }

    function finish() { gameOver = true; document.getElementById('shareBtn').style.display = 'block'; }
    function doShare() {
        const text = `Wordle Remix ${curRow + 1}/${maxAllowed}\n\n${emojis.join('\n')}`;
        navigator.clipboard.writeText(text); alert("æˆ˜ç»©å·²å¤åˆ¶ï¼");
    }
</script>
</body>
</html>
